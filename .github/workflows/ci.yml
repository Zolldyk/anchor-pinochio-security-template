name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  SOLANA_VERSION: '3.1.6'
  ANCHOR_VERSION: '0.32.1'
  RUST_VERSION: '1.92.0'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
        components: rustfmt, clippy
        target: bpf-unknown-unknown

    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install Solana
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

    - name: Install Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked --force

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24.13.0'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm ci

    - name: Check TypeScript compilation
      run: tsc --noEmit

    - name: Check Rust formatting
      run: cargo fmt --all -- --check

    - name: Run Clippy
      run: cargo clippy --all-targets -- -D warnings

    - name: Build all programs
      run: ./scripts/build-all.sh

    - name: Run all tests
      run: ./scripts/test-all.sh

    - name: Verify deployment prevention
      run: |
        # Ensure mainnet deployment is blocked (exclude verify.sh which contains the check itself)
        if grep -r "mainnet-beta" scripts/ --exclude="verify.sh"; then
          echo "ERROR: Mainnet reference found in scripts"
          exit 1
        fi
